name: PR Compliance Check

on:
  pull_request_target:
    types: [opened, edited, reopened]
    branches:
      - main

permissions:
  pull-requests: write
  issues: write

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR and label if non-compliant
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title || '';
            const body = pr.body || '';

            const violations = [];

            // Check 1: PR body must contain the three required template sections
            // These match the exact emoji+heading from the PR template
            const requiredSections = [
              { emoji: 'ðŸ“', heading: 'Description', pattern: /:pencil:|ðŸ“/ },
              { emoji: 'ðŸš¦', heading: 'Testing',     pattern: /:vertical_traffic_light:|ðŸš¦/ },
              { emoji: 'â˜‘ï¸', heading: 'Checklist',   pattern: /:ballot_box_with_check:|â˜‘ï¸/ },
            ];

            const missingSections = requiredSections.filter(
              s => !s.pattern.test(body)
            );

            if (missingSections.length > 0) {
              const missing = missingSections.map(s => `${s.emoji} ${s.heading}`).join(', ');
              violations.push(
                `PR body is missing required template sections: **${missing}**. ` +
                'Please use the [PR template](https://github.com/tardis-sn/.github/blob/main/.github/pull_request_template.md).'
              );
            }

            // Check 2: If title contains "GSoC", body must mention AI/LLM usage
            if (/gsoc/i.test(title)) {
              const mentionsAI = /\bAI\b|LLM/i.test(body);
              if (!mentionsAI) {
                violations.push(
                  'GSoC PRs must include a statement about AI/LLM usage in the PR body. ' +
                  'Please mention whether you used AI or LLM tools and how, per our ' +
                  '[AI Usage Policy](https://tardis-sn.github.io/summer_of_code/ai_usage_policy/).'
                );
              }
            }

            const label = 'auto-close-pending';

            if (violations.length > 0) {
              // Add the label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [label]
              });

              // Post a warning comment
              const message = [
                `âš ï¸ **This PR does not follow the contribution guidelines:**`,
                '',
                ...violations.map(v => `- ${v}`),
                '',
                'Please fix these issues within **48 hours** or this PR will be automatically closed.',
                '',
                'If you fix the issues, the label will be removed automatically.'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message
              });
            } else {
              // PR is compliant â€” remove the label if it exists
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: label
                });
              } catch (e) {
                // Label wasn't present, that's fine
              }
            }
